name: Release Test

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  linux-matrix:
    name: Linux release confidence
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'
      - uses: android-actions/setup-android@v3
      - name: Install Android SDK packages
        run: sdkmanager "platforms;android-36" "build-tools;36.0.0" "platform-tools"
      - uses: gradle/actions/setup-gradle@v3
      - name: Check Gradle wrapper
        id: gradle
        run: |
          if [ -x ./gradlew ]; then
            echo "present=true" >> "$GITHUB_OUTPUT"
          else
            echo "present=false" >> "$GITHUB_OUTPUT"
          fi
      - name: Build
        if: steps.gradle.outputs.present == 'true'
        run: ./gradlew --no-daemon build -x test
      - name: ktlint
        if: steps.gradle.outputs.present == 'true'
        run: ./gradlew --no-daemon ktlintCheck
      - name: detekt
        if: steps.gradle.outputs.present == 'true'
        run: ./gradlew --no-daemon detekt
      - name: Unit tests
        if: steps.gradle.outputs.present == 'true'
        run: ./gradlew --no-daemon test
      - name: JS target tests (if configured)
        if: steps.gradle.outputs.present == 'true'
        shell: bash
        run: |
          if ./gradlew -q tasks --all | grep -q '^jsNodeTest'; then
            ./gradlew --no-daemon jsNodeTest
          else
            echo "jsNodeTest not configured yet; skipping."
          fi
      - name: Kotlin MPP metadata check (if configured)
        if: steps.gradle.outputs.present == 'true'
        shell: bash
        run: |
          if ./gradlew -q tasks --all | grep -q '^allTests'; then
            ./gradlew --no-daemon allTests
          else
            echo "allTests task not configured yet; skipping."
          fi
      - name: Release tests skipped (bootstrap)
        if: steps.gradle.outputs.present != 'true'
        run: echo "No Gradle wrapper yet; release confidence gates will enforce automatically after project scaffold exists."

  macos-ios:
    name: macOS iOS confidence
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'
      - uses: android-actions/setup-android@v3
      - name: Install Android SDK packages
        run: sdkmanager "platforms;android-36" "build-tools;36.0.0" "platform-tools"
      - uses: gradle/actions/setup-gradle@v3
      - name: Check Gradle wrapper
        id: gradle
        run: |
          if [ -x ./gradlew ]; then
            echo "present=true" >> "$GITHUB_OUTPUT"
          else
            echo "present=false" >> "$GITHUB_OUTPUT"
          fi
      - name: iOS simulator tests (if configured)
        if: steps.gradle.outputs.present == 'true'
        shell: bash
        run: |
          if ./gradlew -q tasks --all | grep -q '^iosSimulatorArm64Test'; then
            ./gradlew --no-daemon iosSimulatorArm64Test
          else
            echo "iosSimulatorArm64Test not configured yet; skipping."
          fi
      - name: macOS/iOS checks skipped (bootstrap)
        if: steps.gradle.outputs.present != 'true'
        run: echo "No Gradle wrapper yet; iOS confidence checks will enforce automatically after project scaffold exists."
